generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String?
  theme        String?   // "light" | "dark" | "system"
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  items            Item[]
  projects         Project[]
  tasks            Task[]
  calendarSources  CalendarSource[]
  reviewSessions   ReviewSession[]
  transitionAuditLogs TransitionAuditLog[]
}

enum ItemType {
  task
  project
  reference
  waiting
  someday
  trash
}

enum ItemState {
  INBOX
  CLARIFYING
  ACTIONABLE
  PROJECT
  WAITING
  SNOOZED
  SOMEDAY
  REFERENCE
  DONE
  ARCHIVED
}

enum ContextTag {
  calls
  errands
  computer
  deep_work
}

enum EnergyLevel {
  low
  medium
  high
}

enum ArtifactType {
  draft
  email
  decision
  note
  file
}

enum ProjectStatus {
  CLARIFYING
  ACTIVE
  WAITING
  SOMEDAY
  ON_HOLD
  DONE
  ARCHIVED
}

model Item {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title        String
  body         String    @default("")
  type         ItemType  @default(task)
  state        ItemState @default(INBOX)
  source       String    @default("manual")
  waitingOn    String?
  waitingSince DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  attachments  Json?
  task         Task?
  project      Project?
  artifacts    Artifact[]
  reminders    Reminder[]

  @@index([userId])
  @@index([userId, state])
}

model Task {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId           String?   @unique
  item             Item?     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  actionText       String
  context          ContextTag?
  energy           EnergyLevel?
  estimatedMinutes Int?
  dueDate          DateTime?
  projectId        String?
  project          Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  priority         Int?      @default(0)
  status           String    @default("active")
  snoozedUntil     DateTime?
  pinnedOrder      Int?
  manualRank       Int?
  unverified       Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  projectNextAction Project?  @relation("NextAction")

  @@index([userId])
}

model Project {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  itemId            String?       @unique
  item              Item?         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  outcomeStatement  String?
  status            ProjectStatus @default(CLARIFYING)
  nextActionTaskId  String?       @unique
  nextActionTask    Task?         @relation("NextAction", fields: [nextActionTaskId], references: [id], onDelete: SetNull)
  dueDate           DateTime?
  reviewInterval    Int?
  priority          Int?          @default(0)
  focusThisWeek     Boolean       @default(false)
  lastProgressAt    DateTime?
  themeTag          String?
  waitingOn         String?
  waitingSince      DateTime?
  followUpAt        DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  tasks             Task[]

  @@index([userId])
}

model Artifact {
  id           String       @id @default(cuid())
  artifactType ArtifactType
  content      String?
  filePointer  String?
  linkedItemId String
  linkedItem   Item         @relation(fields: [linkedItemId], references: [id], onDelete: Cascade)
  createdAt    DateTime     @default(now())
}

model Reminder {
  id        String   @id @default(cuid())
  itemId    String?
  item      Item?    @relation(fields: [itemId], references: [id], onDelete: Cascade)
  dueAt     DateTime
  kind      String   @default("snooze")
  createdAt DateTime @default(now())
}

model TransitionAuditLog {
  id               String   @id @default(cuid())
  userId           String?
  user             User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  itemId           String
  fromState        String
  toStateAttempted String
  timestamp        DateTime @default(now())
  actor            String
  decision         String
  reasons          Json?
  override         Boolean  @default(false)
  overrideReason   String?
}

enum ReviewSessionType {
  DAILY
  WEEKLY
}

model ReviewSession {
  id                   String           @id @default(cuid())
  userId               String
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type                 ReviewSessionType
  startedAt            DateTime         @default(now())
  completedAt          DateTime?
  stepsCompleted       Json?
  itemsProcessedCount  Int              @default(0)
  itemsSkippedCount    Int              @default(0)

  @@index([userId])
}

enum CalendarSourceKind {
  ics_import
  microsoft
  google
}

model CalendarSource {
  id           String             @id @default(cuid())
  userId       String
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  kind         CalendarSourceKind
  config       Json?
  lastSyncedAt DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  events       CalendarEvent[]

  @@index([userId])
}

model CalendarEvent {
  id               String         @id @default(cuid())
  calendarSourceId String
  calendarSource   CalendarSource @relation(fields: [calendarSourceId], references: [id], onDelete: Cascade)
  externalId       String?
  title            String
  start            DateTime
  end              DateTime
  allDay           Boolean        @default(false)
  description      String?
  recurrenceRule   String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([calendarSourceId, externalId])
  @@index([calendarSourceId, start, end])
}
